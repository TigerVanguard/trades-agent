# =============================================================================
# Daily Trading Intelligence Brief (DeepSeek Version v2)
# =============================================================================
# 
# åŸºäºã€Šä¸ªäººå…¨æ™¯ç›‘ç‹±ã€‹æ–‡ç« æè¿°çš„å®Œæ•´å®ç°
# 
# æ•°æ®æºï¼š
#   - å›½ä¼šäº¤æ˜“æŠ«éœ² (Congress Trades)
#   - å†…å¹•äº¤æ˜“ (Insider Trading - Form 4)
#   - SEC æ–‡ä»¶ (10-K, 10-Q, 8-K)
#   - å¸‚åœºæ•°æ® (Yahoo Finance)
#   - Polymarket é¢„æµ‹å¸‚åœº
#   - æ–°é—»æ ‡é¢˜
#
# =============================================================================

name: Daily Trading Intelligence (DeepSeek v2)

on:
  # å®šæ—¶è§¦å‘ - æ¯å¤© UTC 14:00 (ç¾è‚¡æ”¶ç›˜åï¼ŒåŒ—äº¬æ—¶é—´22:00)
  schedule:
    - cron: '0 14 * * 1-5'  # å‘¨ä¸€åˆ°å‘¨äº”
  
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      focus_ticker:
        description: 'ç‰¹å®šå…³æ³¨çš„è‚¡ç¥¨ä»£ç ï¼ˆå¯é€‰ï¼‰'
        required: false
        default: ''
      analysis_depth:
        description: 'åˆ†ææ·±åº¦'
        required: false
        default: 'standard'
        type: choice
        options:
          - quick
          - standard
          - deep

concurrency:
  group: daily-trades
  cancel-in-progress: true

env:
  TZ: America/New_York

jobs:
  trading-intelligence:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    permissions:
      contents: write
      pages: write
      id-token: write
      
    steps:
      # =========================================
      # Step 1: æ£€å‡ºä»£ç åº“
      # =========================================
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      # =========================================
      # Step 2: è®¾ç½®Pythonç¯å¢ƒ
      # =========================================
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install openai requests pandas yfinance beautifulsoup4 jinja2
      
      # =========================================
      # Step 3: æ”¶é›†å¸‚åœºæ•°æ®
      # =========================================
      - name: Collect market data
        run: |
          python trades/scripts/collect_market_data.py
      
      # =========================================
      # Step 4: æ”¶é›†å›½ä¼šäº¤æ˜“æ•°æ®
      # =========================================
      - name: Collect congress trades
        run: |
          python trades/scripts/collect_congress_trades.py
      
      # =========================================
      # Step 5: æ”¶é›†å†…å¹•äº¤æ˜“æ•°æ®
      # =========================================
      - name: Collect insider trades
        run: |
          python trades/scripts/collect_insider_trades.py
      
      # =========================================
      # Step 6: æ”¶é›†SECæ–‡ä»¶
      # =========================================
      - name: Collect SEC filings
        run: |
          python trades/scripts/collect_sec_filings.py
      
      # =========================================
      # Step 7: æ”¶é›†Polymarketæ•°æ®
      # =========================================
      - name: Collect Polymarket data
        run: |
          python trades/scripts/collect_polymarket.py
        continue-on-error: true
      
      # =========================================
      # Step 8: ä½¿ç”¨ DeepSeek API ç”Ÿæˆåˆ†ææŠ¥å‘Š
      # =========================================
      - name: Generate trading brief with DeepSeek
        env:
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
          FOCUS_TICKER: ${{ github.event.inputs.focus_ticker }}
          ANALYSIS_DEPTH: ${{ github.event.inputs.analysis_depth || 'standard' }}
        run: |
          python trades/scripts/generate_brief.py
      
      # =========================================
      # Step 9: ç”ŸæˆGitHub Pagesç½‘é¡µ
      # =========================================
      - name: Generate GitHub Pages
        run: |
          python trades/scripts/generate_pages.py
      
      # =========================================
      # Step 10: æäº¤ç”Ÿæˆçš„ç®€æŠ¥
      # =========================================
      - name: Commit trading brief
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          git add trades/output/
          git add trades/data/
          git add docs/
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "ğŸ“Š Daily Trading Brief - $(date +%Y-%m-%d)"
            git push
          fi
      
      # =========================================
      # Step 11: å‘é€é€šçŸ¥
      # =========================================
      - name: Send notifications
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          python trades/scripts/send_notifications.py
        continue-on-error: true
